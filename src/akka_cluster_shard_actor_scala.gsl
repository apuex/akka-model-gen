.template 1
.class_package = "$(model.package).shard"
.pkgdir = "cluster/src/main/scala/$(string.replace(class_package, ".|/"))"
.directory.create(pkgdir)
.for entity
.aggRoot = ""
.if defined(entity.aggregationRoot) & entity.aggregationRoot = "true"
.  pk = extract_pk(entity)
.  aggRoot = entity.name
.
.output "$(pkgdir)/$(entity.name:Pascal)Shard.scala"
/*****************************************************
 ** This file is 100% ***GENERATED***, DO NOT EDIT! **
 *****************************************************/
package $(class_package)

import akka.actor._
import akka.cluster.sharding._
import $(model.package).config._
import $(model.package).domain._
import $(model.package).message._

import scala.math.Numeric.IntIsIntegral._

object $(entity.name:Pascal)Shard {
  def props = Props[$(entity.name:Pascal)]
  def name($(entity.name:Camel)Id: String): String = $(entity.name:Camel)Id.toString

  val shardName: String = "$(entity.name:Pascal)Shard"
  var defaultNumberOfShards = 100

  val extractEntityId: ShardRegion.ExtractEntityId = {
    case cmd: Command =>
      (cmd.entityId.toString, cmd)
  }

  val extractShardId: ShardRegion.ExtractShardId = {
    case cmd: Command =>
      (abs(cmd.entityId.hashCode) % defaultNumberOfShards).toString
  }
}

class $(entity.name:Pascal)Shard extends $(entity.name:Pascal) {
  val settings = Settings(context.system)
  context.setReceiveTimeout(settings.actor.passivateTimeout)

  ClusterSharding(context.system).start(
    $(entity.name:Pascal)Shard.shardName,
    $(entity.name:Pascal)Shard.props,
    ClusterShardingSettings(context.system),
    $(entity.name:Pascal)Shard.extractEntityId,
    $(entity.name:Pascal)Shard.extractShardId
  )

  override def unhandled(message: Any): Unit = message match {
    case x => log.info("unhandled COMMAND: {} {}", this, x)
  }
}

.close
.endif
.endfor
.output "$(pkgdir)/Module.scala"
package $(class_package)

import com.google.inject.AbstractModule
import play.api.libs.concurrent.AkkaGuiceSupport

class Module extends AbstractModule with AkkaGuiceSupport {
  override def configure() = {
.for entity
  .if defined(entity.aggregationRoot) & entity.aggregationRoot = "true"
    bindActor[$(entity.name:Pascal)Shard]("music-actor")
  .endif
.endfor
  }
}
.endtemplate


